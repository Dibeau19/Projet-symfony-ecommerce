{% extends 'base.html.twig' %}

{% block title %}Valider ma commande{% endblock %}

{% block body %}
    <h1>Valider ma commande</h1>

    <div class="row">
        <div class="col-md-6">
            <h3>Récapitulatif</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Produit</th>
                        <th>Prix</th>
                        <th>Quantité</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                        <tr>
                            <td>{{ item.produit.nom }}</td>
                            <td>{{ item.produit.prix }} €</td>
                            <td>{{ item.quantite }}</td>
                            <td>{{ item.produit.prix * item.quantite }} €</td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end"><strong>Total :</strong></td>
                        <td><strong>{{ total }} €</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="col-md-6">
            <form method="post" action="{{ path('commande_index') }}">
                
                {# Display global form errors if any #}
                {{ form_errors(form) }}
                {{ form_errors(carteForm) }}

                <h3>Adresse de livraison</h3>
                
                {% if user.adresses|length > 0 %}
                    <div id="existing-address-container">
                        {% for adresse in user.adresses %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="adresse_id" id="adresse_{{ adresse.id }}" value="{{ adresse.id }}" required>
                                <label class="form-check-label" for="adresse_{{ adresse.id }}">
                                    <strong>{{ adresse.rue }}</strong>, {{ adresse.codePostal }} {{ adresse.ville }} ({{ adresse.pays }})
                                </label>
                            </div>
                        {% endfor %}
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="adresse_id" id="new_address_option" value="new">
                            <label class="form-check-label" for="new_address_option">
                                Nouvelle adresse
                            </label>
                        </div>
                    </div>
                {% endif %}

                <div id="new-address-form" {% if user.adresses|length > 0 %}style="display: none;"{% endif %}>
                    {% if user.adresses|length > 0 %}
                        <hr>
                        <h5>Nouvelle adresse</h5>
                    {% endif %}
                    

                    {{ form_widget(form) }}
                </div>

                <hr class="my-4">

                <h3>Mode de paiement</h3>
                
                {% if user.cartesCredit|length > 0 %}
                    <div id="existing-card-container">
                        {% for carte in user.cartesCredit %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="carte_id" id="carte_{{ carte.id }}" value="{{ carte.id }}" required>
                                <label class="form-check-label" for="carte_{{ carte.id }}">
                                    <strong>xxxx-xxxx-xxxx-{{ carte.numero|slice(-4) }}</strong> (Exp: {{ carte.dateExpiration|date('m/y') }})
                                </label>
                            </div>
                        {% endfor %}
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="carte_id" id="new_card_option" value="new">
                            <label class="form-check-label" for="new_card_option">
                                Nouvelle carte de crédit
                            </label>
                        </div>
                    </div>
                {% endif %}

                <div id="new-card-form" {% if user.cartesCredit|length > 0 %}style="display: none;"{% endif %}>
                    {% if user.cartesCredit|length > 0 %}
                        <hr>
                        <h5>Nouvelle carte</h5>
                    {% endif %}
                    
                    {% if user.cartesCredit|length == 0 %}
                         <p class="mb-3">Veuillez renseigner votre carte de crédit.</p>
                    {% endif %}


                    {{ form_widget(carteForm) }}
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-success btn-lg">Confirmer la commande</button>
                </div>

            </form>
            {# Fin du formulaire unique #}

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const existingAddressContainer = document.getElementById('existing-address-container');
                    const newAddressForm = document.getElementById('new-address-form');
                    
                    const existingCardContainer = document.getElementById('existing-card-container');
                    const newCardForm = document.getElementById('new-card-form');

                    // Fonction pour activer/désactiver les champs d'un conteneur
                    function toggleInputs(container, enable) {
                        const inputs = container.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => {
                            input.disabled = !enable;
                        });
                    }

                    // Initialisation : si on a des adresses existantes, on cache le formulaire "nouveau" et on le désactive
                    if (existingAddressContainer) {
                         // Vérifier si "new" est déjà sélectionné (rechargement de page ?)
                         const newOption = document.getElementById('new_address_option');
                         if (!newOption.checked) {
                             toggleInputs(newAddressForm, false);
                         }
                    }

                    if (existingCardContainer) {
                         const newCardOption = document.getElementById('new_card_option');
                         if (!newCardOption.checked) {
                             toggleInputs(newCardForm, false);
                         }
                    }

                    // Gestion Adresses
                    if (existingAddressContainer) {
                        const addressRadios = existingAddressContainer.querySelectorAll('input[name="adresse_id"]');
                        addressRadios.forEach(radio => {
                            radio.addEventListener('change', function() {
                                if (this.value === 'new') {
                                    newAddressForm.style.display = 'block';
                                    toggleInputs(newAddressForm, true);
                                } else {
                                    newAddressForm.style.display = 'none';
                                    toggleInputs(newAddressForm, false);
                                }
                            });
                        });
                    }

                    // Gestion Cartes
                    if (existingCardContainer) {
                        const cardRadios = existingCardContainer.querySelectorAll('input[name="carte_id"]');
                        cardRadios.forEach(radio => {
                            radio.addEventListener('change', function() {
                                if (this.value === 'new') {
                                    newCardForm.style.display = 'block';
                                    toggleInputs(newCardForm, true);
                                } else {
                                    newCardForm.style.display = 'none';
                                    toggleInputs(newCardForm, false);
                                }
                            });
                        });
                    }
                });
            </script>
        </div>
    </div>
{% endblock %}
