{% extends 'base.html.twig' %}

{% block title %}Valider ma commande{% endblock %}

{% block body %}
    <h1>Valider ma commande</h1>

    <div class="row">
        <div class="col-md-6">
            <h3>Récapitulatif</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Produit</th>
                        <th>Prix</th>
                        <th>Quantité</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                        <tr>
                            <td>{{ item.produit.nom }}</td>
                            <td>{{ item.produit.prix }} €</td>
                            <td>{{ item.quantite }}</td>
                            <td>{{ item.produit.prix * item.quantite }} €</td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end"><strong>Total :</strong></td>
                        <td><strong>{{ total }} €</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="col-md-6">
            <h3>Adresse de livraison</h3>
            
            {% if user.adresses|length > 0 %}
                <form method="post" id="existing-address-form">
                    {% for adresse in user.adresses %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="adresse_id" id="adresse_{{ adresse.id }}" value="{{ adresse.id }}" required>
                            <label class="form-check-label" for="adresse_{{ adresse.id }}">
                                <strong>{{ adresse.rue }}</strong>, {{ adresse.codePostal }} {{ adresse.ville }} ({{ adresse.pays }})
                            </label>
                        </div>
                    {% endfor %}
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="adresse_id" id="new_address_option" value="new">
                        <label class="form-check-label" for="new_address_option">
                            Nouvelle adresse
                        </label>
                    </div>

                    <button type="submit" class="btn btn-success mt-3" id="btn-existing-address">Confirmer avec cette adresse</button>
                </form>
            {% endif %}

            <div id="new-address-form" {% if user.adresses|length > 0 %}style="display: none;"{% endif %}>
                {% if user.adresses|length > 0 %}
                    <hr>
                    <h5>Nouvelle adresse</h5>
                {% endif %}
                
                {{ form_start(form) }}
                    {{ form_widget(form) }}
                    <button type="submit" class="btn btn-primary mt-3">Confirmer avec cette nouvelle adresse</button>
                {{ form_end(form) }}
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const existingForm = document.getElementById('existing-address-form');
                    const newAddressForm = document.getElementById('new-address-form');
                    const btnExisting = document.getElementById('btn-existing-address');
                    
                    if (existingForm) {
                        const radios = existingForm.querySelectorAll('input[name="adresse_id"]');
                        
                        radios.forEach(radio => {
                            radio.addEventListener('change', function() {
                                if (this.value === 'new') {
                                    newAddressForm.style.display = 'block';
                                    btnExisting.style.display = 'none';
                                } else {
                                    newAddressForm.style.display = 'none';
                                    btnExisting.style.display = 'inline-block';
                                }
                            });
                        });
                    }
                });
            </script>
        </div>
    </div>
{% endblock %}
